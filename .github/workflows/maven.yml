name: Java CI with Maven

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *' # every day at 00:00
  workflow_dispatch: # manual triggering

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Get the code from the repository
      uses: actions/checkout@v3
      with:
        ref: 'main'
        fetch-depth: 0 

    - name: Create error logs directory
      run: mkdir -p error-logs

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # Give execute permissions to the build scripts
    - name: Set execute permissions on build scripts
      run: chmod +x bin/build-all.sh bin/quickbuild.sh bin/generate-plantuml-diagrams.sh bin/mvnw || true

    - name: Full build with Maven
      run: ./bin/build-all.sh 2> error-logs/build-all.log || true

    - name: Quick build with Maven
      run: ./bin/quickbuild.sh 2> error-logs/quickbuild.log || true
    
    - name: Upload coverage report for jobs4u.app1
      uses: actions/upload-artifact@v2
      with:
        name: coverage-report-jobs4u.app1
        path: '**/jobs4u.app1/target/site/jacoco/*'

    - name: Upload coverage report for jobs4u.app2
      uses: actions/upload-artifact@v2
      with:
        name: coverage-report-jobs4u.app2
        path: '**/jobs4u.app2/target/site/jacoco/*'

    - name: Upload test report for jobs4u.app1
      uses: actions/upload-artifact@v2
      with:
        name: test-report-jobs4u.app1
        path: '**/jobs4u.app1/target/surefire-reports/*'

    - name: Upload test report for jobs4u.app2
      uses: actions/upload-artifact@v2
      with:
        name: test-report-jobs4u.app2
        path: '**/jobs4u.app2/target/surefire-reports/*'

    - name: Upload error logs
      uses: actions/upload-artifact@v2
      if: always() # This ensures that logs are uploaded even if previous step fails
      with:
        name: error-logs
        path: error-logs/

    - name: Install Graphviz
      run: sudo apt-get install -y graphviz

    - name: Set up Git user
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: Update .svg
      run: ./bin/generate-plantuml-diagrams.sh
      
    - name: Add SVG files
      run: git add *.svg

    - name: Commit and push if there are changes
      run: |
        if ! git diff --cached --quiet; then
          git commit -m "Update diagrams"
          git push origin HEAD:main
        else
          echo "No changes to SVG files"
        fi